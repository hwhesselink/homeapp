# Homeapp
Generate Home Assistant dashboards that behave like the Apple Home app.
Mainly focussed on the Home Assistant Companion app but the dashboards also work in browsers.

Homeapp makes extensive use of Home Assistant areas and labels ("on_home_view", "favorite", "in_summaries") and other settings.
Areas drive dashboard creation, only entities assigned to an area are included.
Labels determine what entities are included on the home page and in chips and badges.
Adding entities is described in [Populating the dashboard](#populating-the-dashboard) below.

# Installation
There's no HACS support yet so to install you'll need access to your Home Assistant config.
The most common ways to do that are:
- SSH ("Advanced SSH & Web Terminal")
- Studio Code Server
- Samba ("Samba share")
- File editor

These are all available via Settings->Add-ons.

## Additional dependencies
These can all be installed via HACS or manually, see their Github pages.

### Card-mod 3
Allows Homeapp to style and tune various elements of the dashboard using CSS.
Use HACS to install or see https://github.com/thomasloven/lovelace-card-mod.
Once installed follow the steps under [Performance improvements](https://github.com/thomasloven/lovelace-card-mod#performance-improvements).

### Mushroom card collection
Almost all the cards Homeapp uses are mushroom cards.
Use HACS to install or see https://github.com/piitaya/lovelace-mushroom.

### Kiosk mode
This is optional.
It allows extra control of the layout of the dashboard.
If installed it will by default remove the unused overflow button for everyone as well as hiding the sidebar and menu button for non-admin users.
Use HACS to install or see https://github.com/NemesisRE/kiosk-mode.

## Configuring Homeapp
The "configs" dict at the top of homeapp.py sets per-dashboard parameters.
If Homeapp is called without arguments the parameters in the "default" entry will be used.
If an argument is passed it will be used as key instead of "default".
Each entry in the configs dict has 5 items:

### Dashboard name
This is the name that will be shown on the home page, it is free-form.

### Dashboard path
This is used to generate the URLs for the pages of the dashboard.
Per the Home Assistant dashboard documentation it needs to contain a hyphen (-) and should probably be all lower-case.

### Dashboard filename
This is the name of the file that will be generated by Homeapp and loaded by Home Assistant.
It must have the "yaml" extension.

### Home Assistant address
This is the address where Home Assistant can be reached.
If Homeapp is running on the same machine as Home Assistant this can be "localhost", otherwise it needs to be the name or IP address where Home Assistant can be reached.

### Home Assistant access
Homeapp accesses Home Assistant via the API and via websockets and authenticates via a long-lived access token.
To generate the token click on your user icon at the bottom of the sidebar, select "Security" and then click on "CREATE TOKEN" under "Long-lived access tokens" at the bottom of the page.
The token will be shown only once, so copy and save it.
It needs to be entered in the "TOKEN ..." field of the configs entry.

## Running Homeapp
Homeapp can be placed anywhere that has permission to access the Home Assistant API and websocket interface and that has Python 3.6 or higher installed.
The dashboard file will be generated where Homeapp is run.
It needs to be placed in the "/config" directory on the Home Assistant system so if Homeapp is run anywhere else then the file will need to be moved there every time Homeapp is run.

## Loading the dashboard
Homeapp needs a background image and a couple of custom templates and helpers installed.

### Background image
Any file can be installed as background, "view_background.jpg" from the repo was used in the screenshots.
If it does not exist create the directory "/config/www".
Then place the file there.
It must be called "view_background.jpg".

### Custom templates
If it does not exist create the directory "/config/custom_templates".
Place the file "summaries.jinja" there.

### Helpers
Create helper templates for temperature and humidity.
For the temperature helper:
1. Go to "Settings->Devices & services->Helpers tab"
2. click on "CREATE HELPER"
3. select "Template"
4. select "Template a sensor"
5. name it "Summary Temperature" (can be anything but this automatically generates the correct Entity ID, see next step)
6. make sure the Entity ID is "sensor.summary_temperature" (see previous step)
7. copy the following to the "State template" field:
```
{% from 'summaries.jinja' import min_max_range %}
{{min_max_range('temperature', label_entities('in_summaries'))}}
```
8. click "SUBMIT" at the bottom and then "FINISH"

For the humidity helper do the same but use "Humidity" in step 5 and make sure the Entity ID is "sensor.summary_humidity" in step 6.
Then copy the following to the "State template" field:
```
{% from 'summaries.jinja' import min_max_range %}
{{min_max_range('humidity', label_entities('in_summaries'))}}
```
and click "SUBMIT" and "FINISH".

### Loading the file
There are several ways to tell Home Assistant to load the dashboard file but the following is recommended.
It keeps UI (storage) mode as the default for dashboards but adds the Homeapp file in yaml mode.
Find the line in "/config/configuration.yaml" that reads "lovelace:" with nothing before or after it.
If it does not exist add it.
Then add the following after the lovelace line indented by 2 spaces (important!):
```
  mode: storage
  dashboards:
    dashboard-path:
      mode: yaml
      title: Dashboard Name
      icon: mdi:home
      show_in_sidebar: true
      filename: filename.yaml
```
So in total, using the parameters from the default configuration, it should look like this:
```
lovelace:
  mode: storage
  dashboards:
    homeapp-myhome:
      mode: yaml
      title: My Home
      icon: mdi:home
      show_in_sidebar: true
      filename: myhome.yaml
```
Now run Homeapp, make sure the output file is installed in "/config", restart Home Assistant, and the dashboard should show up in the sidebar.
The restart is only needed once, to make sure all the newly installed items are picked up.
After that updating the dashboard by re-running Homeapp should make the Companion app ask to refresh.
If it doesn't, pull down the page to force a refresh or reload the browser page.

The dashboard will initally be (almost) empty, the next section describes how to add entities.

# Populating the dashboard
All entities to appear in a dashboard need to be configured.
This can be done piece-meal or in bulk but only needs to be done once.
Home Assistant supports easy bulk updating.

## Areas
Areas can really simplify automations, etc. so are a good idea in general, but Homeapp won't work at all without them.
For my home system I make every room an area, plus garage, front porch, garden and a generic "outside".

Create areas by going to Settings->Areas, labels & zones->Areas tab and clicking "CREATE AREA".
Give the area a name and fill in any other desired fields, Homeapp currently only uses the name.
Once created clicking on the pen icon allows specifying related temperature and humidity sensors but these are currently also not used.

If relevant it can also be useful to add floors ("CREATE FLOOR" on the same page).
This allows for e.g. "Turn off all downstairs lights".

## Labels
Homeapp needs 3 labels:
- on_home_view
- favorite
- in_summaries

Go to the Settings->Areas, labels & zones->Labels tab and create them.
Only the name is used, make sure it is exactly as given here.

Labels work the same way as in Apple Home: setting the "on_home_view" label on an entity will place it on the app home page;
setting "favorite" will place it in the "Favorites" section on the home page (independent of "on_home_view");
the "in_summaries" label will include the entity in the chip count for that kind of entity if it is "on" in some sense (counts are filtered by area in area views).
The "on_home_view" and "favorite" labels only influence whether and how an entity appears on the home page.
The "in_summaries" label only influences how/if chips are shown.

## Configuring entities
The following is a fairly efficient way to bulk-configure the dashboard entities.

### Device areas
To assign devices (and all their entities) to areas:

1. Go to "Settings->Devices & services->Devices tab"
2. Click on "Filters/Integrations"
3. Select only the Integrations that have devices of interest (in my case that narrows the list down by 75%, from around 270 to around 65)
4. Click on the "Enter selection mode" button to the left of the search bar
5. Select all the devices that are in 1 particular area
6. Click on "Move to area" and select that area
7. rinse, repeat for the other areas

### Entity labels
To assign labels to entities:

1. Go to "Settings->Devices & services->Entities tab"
2. Click on "Filters/Domains"
3. Select a domain, e.g. "Lights"
4. Click on the "Enter selection mode" button to the left of the search bar
5. Select all entities that you want to have a particular label
6. Click on "Add label" and select that label (and others if relevant)
7. rinse, repeat

These domains may have relevant entities:

- Alarm control panel
- Binary sensor
- Climate
- Cover
- Fan
- Light
- Lock
- Media player
- Sensor
- Switch
- Vacuum

(For each domain the optimal way to set the filters and sort the columns is different.
For example for lights you might select domain "Lights", sort on "Integration" and add the "in_summaries" label to all lights that do not have integration "Group".)

Once the areas and labels are configured running Homeapp should generate a full Home-style dashboard.

### Tuning
Sometimes an entity will be put on the dashboard that's not wanted.
For instance a templated fan might show up twice: once for the actual fan and once for the template.
Turning off "Visible" in the entity settings for the actual fan will prevent it from appearing on the dashboard.

# Refreshing a dashboard
Homeapp does not need to be re-run for all changes.
For instance when the name of an entity is changed it will update in Homeapp dashboards.
This is normal Home Assistant behaviour.
However when an entity is added or deleted or moved to a different area the layout may change and Homeapp will need to be re-run.
